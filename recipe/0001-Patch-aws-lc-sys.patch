From 6f7f44a2fec77d20898557d2e53d58944d433a47 Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Wed, 30 Apr 2025 22:27:44 +0200
Subject: [PATCH] Patch aws-lc-sys

---
 Cargo.toml           |  9 +++++++++
 aws-lc-sys-cxx.patch | 25 +++++++++++++++++++++++++
 2 files changed, 34 insertions(+)
 create mode 100644 aws-lc-sys-cxx.patch

diff --git a/Cargo.toml b/Cargo.toml
index 6d0c133..a622b99 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -41,3 +41,12 @@ opt-level = 3
 debug = false
 lto = true
 codegen-units = 1
+
+[package.metadata.patch.aws-lc-sys]
+version = "0.28.1"
+patches = [
+  { path = "aws-lc-sys-cxx.patch", source = "GithubPrDiff" }
+]
+
+[patch.crates-io]
+aws-lc-sys = { path = "./target/patch/aws-lc-sys-0.28.1" }
diff --git a/aws-lc-sys-cxx.patch b/aws-lc-sys-cxx.patch
new file mode 100644
index 0000000..92b8f32
--- /dev/null
+++ b/aws-lc-sys-cxx.patch
@@ -0,0 +1,25 @@
+diff --git a/aws-lc-sys/builder/cc_builder.rs b/aws-lc-sys/builder/cc_builder.rs
+index 8c1d4d94e44..fe1e1049004 100644
+--- a/builder/cc_builder.rs
++++ b/builder/cc_builder.rs
+@@ -202,7 +202,7 @@ impl CcBuilder {
+             set_env_for_target("CC", &cc);
+         }
+         if let Some(cxx) = optional_env_optional_crate_target("CXX") {
+-            set_env_for_target("CC", &cxx);
++            set_env_for_target("CXX", &cxx);
+         }
+ 
+         if target_arch() == "x86" && !compiler_is_msvc {
+diff --git a/aws-lc-sys/builder/cmake_builder.rs b/aws-lc-sys/builder/cmake_builder.rs
+index cc6b19eb587..fef7cf7e9a8 100644
+--- a/builder/cmake_builder.rs
++++ b/builder/cmake_builder.rs
+@@ -110,6 +110,7 @@ impl CmakeBuilder {
+ 
+         // Build flags that minimize our crate size.
+         cmake_cfg.define("BUILD_TESTING", "OFF");
++        cmake_cfg.define("BUILD_TOOL", "OFF");
+         if cfg!(feature = "ssl") {
+             cmake_cfg.define("BUILD_LIBSSL", "ON");
+         } else {
